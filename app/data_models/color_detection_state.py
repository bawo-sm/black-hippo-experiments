"""State model for the color detection workflow."""
from typing import Optional, Dict, Any, List
from pydantic import BaseModel, Field


class ColorConfidence(BaseModel):
    """Confidence metadata for a single color slot."""
    detail_color_confidence: Optional[float] = Field(
        default=None,
        description="Confidence score (0.0-1.0) for the detail color selection"
    )
    main_color_confidence: Optional[float] = Field(
        default=None,
        description="Confidence score (0.0-1.0) for the main color mapping"
    )
    reasoning: Optional[str] = Field(
        default=None,
        description="Brief reasoning for the color choice"
    )


class ColorDetectionState(BaseModel):
    """State model for the color detection graph."""
    
    # Image data
    image_data: Optional[str] = Field(
        default=None,
        description="Base64 encoded image, image URL, or data URI"
    )
    
    # Item metadata (optional, for enhanced color detection)
    supplier_reference_description: Optional[str] = Field(
        default=None,
        description="Product name/description from supplier"
    )
    materials: Optional[str] = Field(
        default=None,
        description="Materials information, e.g. 'MANGO WOOD (70.00%), IRON (30.00%)'"
    )
    
    # Image description (generated by describeImage node)
    image_description: Optional[str] = Field(
        default=None,
        description="Color-focused description of the image"
    )
    
    # Estimated color count from description step
    estimated_color_count: Optional[int] = Field(
        default=None,
        description="Estimated number of distinct colors from description step"
    )
    
    # Detail colors (1-3 slots)
    detail_color_1: Optional[str] = Field(
        default=None,
        description="Primary detail color from Colors.xlsx"
    )
    detail_color_2: Optional[str] = Field(
        default=None,
        description="Secondary detail color from Colors.xlsx"
    )
    detail_color_3: Optional[str] = Field(
        default=None,
        description="Tertiary detail color from Colors.xlsx"
    )
    
    # Mapped main colors (deterministically derived from detail colors)
    main_color_1: Optional[str] = Field(
        default=None,
        description="Main color corresponding to detail_color_1"
    )
    main_color_2: Optional[str] = Field(
        default=None,
        description="Main color corresponding to detail_color_2"
    )
    main_color_3: Optional[str] = Field(
        default=None,
        description="Main color corresponding to detail_color_3"
    )
    
    # Multi flag
    is_multi: bool = Field(
        default=False,
        description="True when item has >3 distinct colors"
    )
    
    # Confidence metadata per color slot
    confidence_1: Optional[ColorConfidence] = Field(
        default=None,
        description="Confidence metadata for color slot 1"
    )
    confidence_2: Optional[ColorConfidence] = Field(
        default=None,
        description="Confidence metadata for color slot 2"
    )
    confidence_3: Optional[ColorConfidence] = Field(
        default=None,
        description="Confidence metadata for color slot 3"
    )
    
    # Processing metadata
    classification_history: List[Dict[str, Any]] = Field(
        default_factory=list,
        description="History of color detection steps"
    )
    
    errors: List[str] = Field(
        default_factory=list,
        description="List of errors encountered during color detection"
    )
    
    def add_classification_step(self, step: str, result: str, metadata: Optional[Dict[str, Any]] = None):
        """Add a classification step to history."""
        self.classification_history.append({
            "step": step,
            "result": result,
            "metadata": metadata or {}
        })
    
    def add_error(self, error: str):
        """Add an error to the errors list."""
        self.errors.append(error)
    
    def to_dict(self) -> Dict[str, Any]:
        """Convert state to dictionary for API response."""
        result = {
            "detail_color_1": self.detail_color_1,
            "detail_color_2": self.detail_color_2,
            "detail_color_3": self.detail_color_3,
            "main_color_1": self.main_color_1,
            "main_color_2": self.main_color_2,
            "main_color_3": self.main_color_3,
            "is_multi": self.is_multi,
            "errors": self.errors,
            "metadata": {
                "image_description": self.image_description,
                "confidence": {}
            }
        }
        
        # Add confidence metadata for non-null color slots
        for i in range(1, 4):
            conf = getattr(self, f"confidence_{i}")
            if conf is not None:
                result["metadata"]["confidence"][f"color_{i}"] = {
                    "detail_color_confidence": conf.detail_color_confidence,
                    "main_color_confidence": conf.main_color_confidence,
                    "reasoning": conf.reasoning,
                }
        
        return result
